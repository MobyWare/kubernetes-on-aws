systemd:
  units:
    - name: "rpcbind.service"
      enable: true
    - name: "kubelet.service"
      enable: true
      contents: |
        [Service]
        Environment=KUBELET_IMAGE_TAG=v1.7.3_coreos.0
        Environment="RKT_RUN_ARGS=--uuid-file-save=/var/run/kubelet-pod.uuid \
          --volume dns,kind=host,source=/etc/resolv.conf \
          --mount volume=dns,target=/etc/resolv.conf \
          --volume var-log,kind=host,source=/var/log \
          --mount volume=var-log,target=/var/log"
        ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests
        ExecStartPre=/usr/bin/mkdir -p /var/log/containers
        ExecStartPre=-/usr/bin/rkt rm --uuid-file=/var/run/kubelet-pod.uuid
        ExecStart=/usr/lib/coreos/kubelet-wrapper \
          --api-servers=https://10.0.70.50 \
          --container-runtime=docker \
          --register-node=true \
          --allow-privileged=true \
          --pod-manifest-path=/etc/kubernetes/manifests \
          --cluster_dns=10.3.0.10 \
          --cluster_domain=cluster.local \
          --network-plugin=cni \
          --cni-bin-dir=/opt/cni/bin \
          --cni-conf-dir=/etc/kubernetes/cni/net.d \
          --kubeconfig=/etc/kubernetes/worker-kubeconfig.yaml \
          --tls-cert-file=/etc/kubernetes/ssl/worker.pem \
          --tls-private-key-file=/etc/kubernetes/ssl/worker-key.pem \
          --client-ca-file=/etc/kubernetes/ssl/ca.pem \
          --cloud-provider=aws 
        ExecStop=-/usr/bin/rkt stop --uuid-file=/var/run/kubelet-pod.uuid
        Restart=always
        RestartSec=10

        [Install]
        WantedBy=multi-user.target

storage:
  files:
    - path: "/etc/sysctl.d/sysctl.conf"
      filesystem: "root"
      mode: 644
      contents:
        inline: |
          vm.max_map_count = 262144
    - path: "/etc/kubernetes/manifests/kube-proxy.yaml"
      filesystem: "root"
      mode: 644
      contents:
        remote: 
          url: https://raw.githubusercontent.com/upmc-enterprises/kubernetes-on-aws/master/yaml/kube-proxy.yaml
    - path: "/etc/kubernetes/worker-kubeconfig.yaml"
      filesystem: "root"
      mode: 644
      contents:
        inline: |
          apiVersion: v1
          kind: Config
          clusters:
          - name: local
            cluster:
              certificate-authority: /etc/kubernetes/ssl/ca.pem
          users:
          - name: kubelet
            user:
              client-certificate: /etc/kubernetes/ssl/worker.pem
              client-key: /etc/kubernetes/ssl/worker-key.pem
          contexts:
          - context:
              cluster: local
              user: kubelet
            name: kubelet-context
          current-context: kubelet-context
    - path: "/etc/kubernetes/cni/net.d/10-flannel.conf"
      filesystem: "root"
      mode: 644
      contents:
        inline: |
          {
            "name": "podnet",
            "type": "flannel",
            "delegate": {
              "isDefaultGateway": true
            }
          }
    - path: "/etc/kubernetes/ssl/ca.pem"
      filesystem: "root"
      mode: 644
      contents:
        inline: |
          -----BEGIN CERTIFICATE-----
          MIIDGjCCAgKgAwIBAgIJAJ9qEsLLV83PMA0GCSqGSIb3DQEBBQUAMBIxEDAOBgNV
          BAMTB2t1YmUtY2EwHhcNMTcwNzMxMTgzOTU0WhcNNDQxMjE2MTgzOTU0WjASMRAw
          DgYDVQQDEwdrdWJlLWNhMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
          qjq0ZoCHwERNz04P5yohyYVSNL9F/oOB+dzn7rU4VGGP8zIcESHDRKUi61D4Sayw
          KpobZKiu7qEqV/oRwY/Cwp47z+zvArw9oaMEr/sl/S0bkuRUVIwj76WyokQOYWN3
          5znxWun+kOVw1fnCqbzq4oFLdhdwqL8YP96T3MwMKe+XccFFHZQrzSqWLYrahkGe
          k+CMbm5zWespHDnPRWOXTYqQR6l7mWLTreAWrE3yanZ80yTkdBHwJ7Fi2ibG88fG
          2KwvWZnwFMvTgJM9SJ4mWEztIkygDyxRPjvBFal65MnxRQJnjkzi2GcefcXTX1TM
          RefJ+KmtEMmx1mKXdszNLwIDAQABo3MwcTAdBgNVHQ4EFgQUu6RK2Do+7spfaAm7
          eT4ZQsD1EDgwQgYDVR0jBDswOYAUu6RK2Do+7spfaAm7eT4ZQsD1EDihFqQUMBIx
          EDAOBgNVBAMTB2t1YmUtY2GCCQCfahLCy1fNzzAMBgNVHRMEBTADAQH/MA0GCSqG
          SIb3DQEBBQUAA4IBAQAxEyEsrwT5IDTBBgxaMPOwEPWJqB0KE10m9L6Z6IP7Q/Ee
          KaeaaZX8rHOIUGlF1fUdHfYxFw1NV4J5fORum7yXRB3CBftsplzyOW6paeNt5Gal
          VHz9cxgNygWHOfbTKFJVa9HEh+pYbp0Ko07Cbj8Ev7bH6aQjU04IfaZEMhI1Y/WQ
          AT7m7R27ttIWX2RueVRdBaGNMUweBWg5Smnof+xiuQIoJNzzqFVRUOurvTAJw3rd
          FNiDDb8ozm04sYmNN4bgbQyyYNrO30BsNJpA7p9qr92bV3zU4fGC9mndQI1n2u7O
          lLGCuXbyMuhTp/upUcJTjxA9vXsfzlZF5OW+WcsR
          -----END CERTIFICATE----- 
    - path: "/etc/kubernetes/ssl/worker.pem"
      filesystem: "root"
      mode: 644
      contents:
        inline: |
          -----BEGIN CERTIFICATE-----
          MIIDEjCCAfqgAwIBAgIJAJxrbQ79ntkNMA0GCSqGSIb3DQEBBQUAMBIxEDAOBgNV
          BAMTB2t1YmUtY2EwHhcNMTcwODAxMTczODI2WhcNMTgwODAxMTczODI2WjAyMRkw
          FwYDVQQDDBB3b3JrZXIuazhzLmxvY2FsMRUwEwYDVQQKDAxzeXN0ZW06bm9kZXMw
          ggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC5h++4V0F7lxaAkSX3oAgp
          a4SbS6YTO9ka1qYPvZiTE6YwvNm1nhPSv58y713SPhKYPy49wCCNudvKdSK/TfG2
          KC56J01R1BxheSGpjxoskombM/itddc3aCq6KxiY3UrQPDuC3Xq2+Io0rdo91rNg
          SpLBdUsSayESu3jMJRT3bTaddDrPWcZwNFTpBwJan5jASsdOaw3ZtQ94cHRi67KU
          BiGfzobSSYuHKRoJIKf6+JJOK9n3j7A2/5Pdn6twLhT5FBaZx2OLrXwcOgjNJu/9
          +BktnAlT4xxMQ/pH+l/pkQTdcOsoebgMuBhKyPIKL23FMI8wFjnM8AfTD8fHyCc7
          AgMBAAGjSzBJMAkGA1UdEwQCMAAwCwYDVR0PBAQDAgXgMC8GA1UdEQQoMCaCFCou
          Ki5jbHVzdGVyLmludGVybmFsgg4qLmVjMi5pbnRlcm5hbDANBgkqhkiG9w0BAQUF
          AAOCAQEAGceXOVDkA8id9Ht8+ekh3U3OEFl5BvoNAX9jlyNuoMoLUfvP7Gu2nnru
          AR1B0m3/59ODtxSmZchvPpmz6m2xuupsvts4yddbNmozntryzImhwA67ymulJpjD
          VOuQQ5X0cuLGYrU9LfAp2lkytjZhpUTR/jQSEfxRkjaHLICQng88aeBIotGyhO0k
          kZlUHqCfjP6pNB2menor1qomDn9uIYsSfzijaIGLEMnP2+dOqCQ3nrkz1fzzvERY
          6qgelOvkeyr7LTrvybvINJmJ7eCwsLUUpn/mi0jW4uQnxUxiL5k9E8iRfCduobVV
          hvyQDIgjX8b42z7bAQMocTnQ87L33g==
          -----END CERTIFICATE-----
    - path: "/etc/kubernetes/ssl/worker-key.pem"
      filesystem: "root"
      mode: 644
      contents:
        inline: |
          -----BEGIN RSA PRIVATE KEY-----
          MIIEpAIBAAKCAQEAuYfvuFdBe5cWgJEl96AIKWuEm0umEzvZGtamD72YkxOmMLzZ
          tZ4T0r+fMu9d0j4SmD8uPcAgjbnbynUiv03xtigueidNUdQcYXkhqY8aLJKJmzP4
          rXXXN2gquisYmN1K0Dw7gt16tviKNK3aPdazYEqSwXVLEmshErt4zCUU9202nXQ6
          z1nGcDRU6QcCWp+YwErHTmsN2bUPeHB0YuuylAYhn86G0kmLhykaCSCn+viSTivZ
          94+wNv+T3Z+rcC4U+RQWmcdji618HDoIzSbv/fgZLZwJU+McTEP6R/pf6ZEE3XDr
          KHm4DLgYSsjyCi9txTCPMBY5zPAH0w/Hx8gnOwIDAQABAoIBABYleuEHUWK+W0pH
          iT+w06iWFAMxmYZsO3Mvsizo1eCglNL2iApc70LV6tv6pLlm/XM8/3kRiRFB4VGe
          f+JUHIlA7KNaM6mT5ztfaTxDP72YVGK5ZnLWQTV08ry8TjhZGggXWIc7ht12d5Do
          O8fr7AePf0smhCqTrSP+SuIbfxA1vh8GZuzw9xkend2TNMV/QdvnsYjmN6AoQbcr
          d1Q/irH6nTn4OL7eXkfGZfu9qeDkNlUTR6WuIff3YBD/w5OHDTUst4RKB5+vQsoh
          Pv5MclNH9tfHFb0RRtHHIYHMN6PyrGfKcJC5F2gxajNXcKngu3qCEpLU3jYUgn1g
          oLx6RdECgYEA4zbiKoj05AKkfsqSgdJjNcSdoJ6P8ldLT1jFfHfPqBHg8wj05tH4
          PSqh3SrJoRG2FLPdZEUHNeOFzeOl48vre0zPxoyIHJ5q69b4Ma5SanvWe30EvNCe
          MAQqFU6ActfGO921LgZS7JyhO6khnfA0+ozGzGNm9ivcI+Q0asTDOFkCgYEA0Qko
          ugDTjkqv+MzWyy90ZgVo+PwcaEzpxWDZIC2kReKrxOeACTS83XV5eAdrjrKbjt8j
          RevwMRYjvab+PoS59BT8dfqLO3uUnrBk+1xeoRIj5xDE7pcAVk5BQInleb6hT/AH
          6J5I9E0D1hg5eUxcQCFbfZdlPbU2TCFH31kdqbMCgYEAseoG3JGTWHrtPU73u2n3
          P2Hun5epVXSfRslXEihq1MrzHrrzsU3WmGaqihj3+wR4U+unPt2CUOMQofBQtHe3
          szupMmpWJjqxtGwGujgq1rCTeOyi6gpc43JPVZG7qLFmyvfG5/wRsK7Q3XuJFDfD
          9DCJdf+b3sTnQr9tf/EEgDkCgYBgvkduBlHi6egVUuAZ+2V4jgpuKWgQUYBjzBXR
          Ea6UdXqfz7BvEkxShjrodS6vRTQ/ZEAT7UUlwqRZ8r56Or1BHLFW/NSRe/lllCe4
          OaDGFPoux5ENBy+twdvrPabJuJM5xtIyM4d6IWakIGQBInkTaRzJvFarv4FYrJJx
          6PGUhwKBgQCc2vtmDCYshZlhFi9kxhGVgvPJ6UgPoA4zkJOmIFw060jowdLu+w+g
          vn4Q9AxJ7r4JchGOIxH3xqdFyKkhyuGo9/YEh88cCUERSGY6h8VfuKmN8Yx02bp7
          GUK7fe25/AcIaFk8Im5L5OYHhK0vx9gfvyr6DXb8feSB6Wioa+ERFg==
          -----END RSA PRIVATE KEY-----

locksmith:
  reboot_strategy: "off"